dist: bionic
language: python
python:
  - "3.7"
env:
  - PYTHONUNBUFFERED=1
jobs:
  include:
    - name: pylint
      install: pip install pylint==2.4.1
      script: pylint osbuild runners/* assemblers/* stages/* sources/*
    - name: unit-tests
      script:
        - python3 -m unittest test.test_osbuild
        - python3 -m unittest test.test_objectstore
    - name: rpm-f31
      services:
        - docker
      script: docker run --rm -v $(pwd):/src fedora:31 sh -c "cd /src && dnf install -y 'dnf-command(builddep)' make git rpm-build && dnf builddep -y osbuild.spec && make rpm"
    - name: rpm-f32
      services:
        - docker
      script: docker run --rm -v $(pwd):/src fedora:32 sh -c "cd /src && dnf install -y 'dnf-command(builddep)' make git rpm-build && dnf builddep -y osbuild.spec && make rpm"
    - name: rpm-f33
      services:
        - docker
      script: docker run --rm -v $(pwd):/src fedora:33 sh -c "cd /src && dnf install -y 'dnf-command(builddep)' make git rpm-build && dnf builddep -y osbuild.spec && make rpm"
    - name: pipeline-noop
      before_install: sudo apt-get install -y systemd-container
      script:
        - sudo env "PATH=$PATH" python3 -m osbuild --libdir . --build-env samples/ubuntu1804.json samples/noop.json
        - sudo env "PATH=$PATH" python3 -m osbuild --libdir . --build-env samples/ubuntu1804.json samples/noop.json
    - name: sources-tests
      before_install: sudo apt-get install -y rpm
      script: sudo env "PATH=$PATH" python3 -m unittest -v test.test_sources
    - name: f30-boot
      before_install: sudo apt-get install -y systemd-container yum qemu-kvm
      script: sudo env "PATH=$PATH" "OSBUILD_TEST_BUILD_ENV=samples/f27-build-from-ubuntu1804.json" python3 -m unittest -v test.test_boot
    - name: assemblers
      before_install: sudo apt-get install -y systemd-container yum tar qemu-utils nbd-client
      script: sudo env "PATH=$PATH" "OSBUILD_TEST_BUILD_ENV=samples/f27-build-from-ubuntu1804.json" python3 -m unittest -v test.test_assemblers
    - name: stage-tests
      before_install: sudo apt-get install -y systemd-container yum
      script: sudo env "PATH=$PATH" "OSBUILD_TEST_BUILD_ENV=samples/f27-build-from-ubuntu1804.json" python3 -m unittest -v test.test_stages
